---
title: "COVID Modeling and the Crop Cycle"
author: "Prepared May/June 2020 by the Data, Monitoring, and Analytics Team at USAID/RFS"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M:%S %Z')`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    highlight: tango
    latex_engine: xelatex
    keep_tex: true
  # html_document:
  #   toc: true
  #   #toc_float: true
  #   toc_depth: 3
  #   #number_sections: true
  #   theme: cosmo
  #   highlight: tango
# header-includes:
#   - \usepackage{fontspec}
fontsize: 10pt
geometry: margin= 0.75in
# https://github.com/Homebrew/homebrew-cask-fonts/tree/master/Casks
mainfont: Latin Modern Sans #Arial #Helvetica
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
source('functions.R')
suppressPackageStartupMessages(source('load_libs.R'))
# get data files we need
datadir = "~/paultangerusda drive/2020_Sync/COVID analysis (Paul Tanger)/data/"
map.plots = readRDS(paste0(datadir, "map.plots_20200611_1057.RDS"))
PeaksbyCountry.wide.plots = read.csv(paste0(datadir, "PeaksbyCountry.wide.plots_20200611_1003.csv"))
colnames(PeaksbyCountry.wide.plots) = c("USAID_Country", "Region", "Scenario", "Peak Cases Date", "Peak Deaths Date")
```
\newpage
# Cover Page
## Introduction:
The effects of COVID-19 go well beyond the initial acute health impacts into prolonged secondary repercussions on the economy, employment, poverty levels, safe water access, food security status, crop production, and much more.  In this analysis, we looked at whether projections of COVID-19 case totals in low-and-middle-income countries (LMICs) overlapped with key phases in the crop production cycle to understand where, when, and on which important crops COVID-19 could take a toll.  From this work, we can better inform our thinking on where to focus our programming, estimate which areas will be hit hardest next, and whether COVID-19 impacts will affect crops that are significant food sources, income generators, or both.  Combined with data on the demographics of value chain actors involved in each affected crop, we could also see whether the impacts are projected to disproportionately impact women, smallholder farmers, small businesses, and other already-marginalized groups. 

## Methodology:
We began with time series projections of COVID-19 case totals from a model developed by the Centre for the Mathematical Modelling of Infectious Diseases (CMMID) at the London School of Hygiene & Tropical Medicine (LSHTM)^[Data source for Model projections of COVID-19 cases and deaths over time:  Centre for the Mathematical Modelling of Infectious Diseases (CMMID) at the London School of Hygiene & Tropical Medicine (LSHTM); https://cmmid.github.io/topics/covid19/LMIC-projection-reports.html], and overlaid those data with the calendar/timing of phases of the crop cycles in various countries from the Crop Monitor initiative of the Group on Earth Observations Global Agricultural Monitoring Initiative (GEOGLAM)^[Data source for Crop calendars:  Crop Monitor initiative from Group on Earth Observations Global Agricultural Monitoring Initiative (GEOGLAM); https://cropmonitor.org/index.php/eodatatools/baseline-data/] to observe if peaks in the number of cases for a country were projected to occur at the same time as a key phase in the cycle of production for crops important to that country.

## The LSHTM model:
* This model provides simulation-based estimates for COVID-19 epidemic scenarios in many low-and-middle-income countries.  The model starts with the date a country reached 50 cases (i.e. “Day 0”), and then projects the totals of several variables (cases, deaths, hospitalizations, etc.) each day over time for an ‘unmitigated’ scenario (i.e. the country takes no action to contain COVID-19 spread), as well as in six different COVID-19 containment strategies involving social distancing, shielding, or a combined approach.  The projections estimate how different containment strategies could have different outcomes on the spread and intensity of the disease in a country.  

* While you can see the full results of the LSHTM research for each country here, the line graphs in this document plot the model’s projections for each country’s case totals across time for the seven scenarios (unmitigated plus six containment strategies) for all age groups combined.  

* ‘Day 0’ is defined as the date the country reached 50 confirmed cases, according to the Johns Hopkins Coronavirus Resource Center^[Data source for Date of the 50th confirmed COVID-19 case:  Johns Hopkins University Coronavirus Resource Center; https://coronavirus.jhu.edu/].  Note that the date of 50 confirmed cases likely occurs after the date a country actually had 50 cases.  Since the model is based on the latter, this means the true peaks of the different scenarios are likely to occur earlier in time than shown here, i.e. the peaks would shift to the left.  A future update of this analysis will incorporate a more accurate estimate of the true ‘Day 0’.

* Refer to the LSHTM link in the footnotes for more details on the model, including the definition of the different scenarios, their methodologies for determining transmission rates, etc.

## The GEOGLAM crop calendars:
* For each country, the timing of crop production phases was plotted for significant staple crops, and for each sub-national area where production occurs in a country.  In the case of multiple crop seasons such as maize 1 and maize 2, the more significant season in terms of total production will be labeled as the first crop, e.g, maize 1.

* The phases of the crop production cycle reflected in this analysis were defined as:

  + Planting: Start of Planting through the Early Vegetative stage
  + Idle (represents the dormancy stage of winter wheat where applicable)
  + Vegetative: Start of Vegetative period through the Reproductive period (Period of peak weeding)
  + Harvest: Ripening through Harvest

* For the crop calendars displayed in this document, each sub-national area is represented where the timing of the crop production cycle differs.  In cases where crop cycles followed the same timing throughout the country, only one crop calendar is shown for that country.

## How to read the analysis:
In the following pages, each country’s analysis contains:  

1. a graph of the LSHTM projections of COVID-19 case totals over times (all age groups combined) for an unmitigated scenario plus six disease containment scenarios;
2. a crop calendar showing when the crop production phases of key staple crops occur throughout the year (with multiple crop calendars in cases where variation in timing occurs);
3. a map of the country, with the sub-national area highlighted in cases where there are multiple crop calendars per country (due to variation in timing by area);
4. a table listing the estimated dates of when peak COVID-19 cases and peak COVID-19 deaths are projected to occur in the country, according to the LSHTM model.

The countries are listed in alphabetical order.  Following the analysis pages for each country, we have included the LSHTM COVID-19 case totals projections across time, summarized by geographic region.

## Caveats/Notes:
* These are projections based on a model with documented assumptions.  That model will be updated as the LSHTM gathers more information, as noted here.
* As noted above, the ‘Day 0’ used for the graphs here likely occurred later than the actual ‘Day 0’, and these graphs will be updated once we obtain more accurate estimates of when a country reached 50 cases.
* The crop calendars do not include all crops grown in the country, nor all those that are important as a food source or for income generation.
Maps, area names, and borders do not necessarily reflect the concurrence of the US Government.

<div style="page-break-after: always;"></div>
\newpage
# Country Specific Information
\newpage
```{r setup_sec_function, results='asis', include=FALSE} 
# outwidth is for pdf
# results='asis'
# setup function to create country sections

create_section <- function(i) {
  # Inserts "## Title (auto)"
  pander::pandoc.header(names(map.plots[i]), level = 2) #cat(names(map.plots[i]))
  pander::pandoc.p('')
  pander::pandoc.p('This is the beginning of the section')
  pander::pandoc.p('')
  # get the items in the country list to plot
  # plots side by side
  # https://bookdown.org/yihui/rmarkdown-cookbook/figures-side.html
  # https://sebastiansauer.github.io/two-plots-rmd/
  # https://stackoverflow.com/questions/37115276/control-alignment-of-two-side-by-side-plots-in-knitr
  
  # the peak plot and crop plots (combined)
  # if want to separate, for example, to rearrange, go back and use: 
  # plots_to_combine[[i]]$cases, plots_to_combine[[i]]$crop_plot
  grid.arrange(map.plots[[names(map.plots[i])]][['bottom']])

  
  # little table of key dates
  # can use kable or pander
  # https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
  tabledata = PeaksbyCountry.wide.plots[PeaksbyCountry.wide.plots$USAID_Country == names(map.plots)[i], ]
  print(tabledata[,c(3:5)] %>%
      kable(caption = "Estimates of key dates") %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed", full_width=F, position = "left"))) # font_size = 7

  # the actual maps
  grid.arrange(map.plots[[names(map.plots[i])]][['map_plot']])
  
  #panderOptions("digits", 2)
  #pander(tabledata[,c(3:5)])

  # text at end
   pander::pandoc.p('')
   pander::pandoc.p('Data sources:
  * Model projections of COVID-19 cases and deaths over time:  Centre for the Mathematical Modelling of Infectious Diseases (CMMID) at the London School of Hygiene & Tropical Medicine (LSHTM); https://cmmid.github.io/topics/covid19/LMIC-projection-reports.html
  * Crop calendars: Crop Monitor initiative from Group on Earth Observations Global Agricultural Monitoring Initiative (GEOGLAM); https://cropmonitor.org/index.php/eodatatools/baseline-data/
  * Date of the 50th confirmed COVID-19 case: Johns Hopkins University Coronavirus Resource Center; https://coronavirus.jhu.edu/
  Prepared by the Data, Monitoring, and Analytics Team at USAID/Bureau for Resilience and Food Security; https://www.usaid.gov/who-we-are/organization/bureaus/bureau-resilience-and-food-security.  For questions on this analysis, please contact RFSAnalyticsQueries@usaid.gov.')
   pander::pandoc.p('')
   #pander::pandoc.p('\\newpage')
}
```

```{r run_loop, echo=FALSE}
# options for results are asis - passthrough.. hold - put all results below code
# METHOD 2
#out = NULL
# METHOD 3
out = NULL
# consider moving this to a child template if it gets unwieldy.
# in that case, it would work like:
# put this in loop: out = c(out, knit_expand('template.rmd'))
# Then have your 'template.rmd' be: ### Species = {{i}}
# or check this: https://stackoverflow.com/questions/58189760/print-ggplot2-and-lm-objects-in-a-loop-in-rmarkdown

for(i in seq(map.plots)){
  # METHOD 1 (with function in above code chunk)
  #create_section(i)
  #cat('\\pagebreak')
  
  # METHOD 2
  #out = c(out, knit_expand(text='## {{names(map.plots[i])}}'))
  # METHOD 3
  out = c(out, knit_expand('CountryTemplate.Rmd')) # this is for child template option
  
  # add other stuff to section
  #cat(paste0("\n\n## ", i, "\n"))
  #print(grid.draw(map.plots[[names(map.plots[i])]][['map_plot']]))
  #print(grid.arrange(map.plots[[names(map.plots[i])]][['map_plot']]))
  #grid.arrange(map.plots[[names(map.plots[i])]][['map_plot']])
}

# METHOD 2 and 3 move this below to test
#`r paste(knit(text = out), collapse = '\n')`
# or this:
#`r knitr::knit(text = unlist(src))`
```

`r paste(knit(text = out), collapse = '\n')`

